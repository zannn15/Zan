name: RDP Access

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP and Configure Firewall
        run: |
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Disable NLA for simpler auth
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          
          # Configure firewall
          netsh advfirewall firewall delete rule name="RDP-Port" > $null 2>&1
          netsh advfirewall firewall add rule name="RDP-Port" dir=in action=allow protocol=TCP localport=3389
          
          # Restart service
          Restart-Service -Name TermService -Force
          Write-Host "RDP Enabled Successfully"

      - name: Create User Account
        run: |
          # Simple user creation using net user (MOST RELIABLE METHOD)
          $username = "RDPUser"
          $password = "vizzan15"
          
          # Delete if exists (ignore errors)
          net user $username /delete 2>$null
          
          # Create user
          net user $username $password /add
          
          # Add to groups
          net localgroup Administrators $username /add
          net localgroup "Remote Desktop Users" $username /add
          
          # Enable user if disabled
          net user $username /active:yes
          
          # Verify and display
          Write-Host "`n=== USER CREATED ==="
          Write-Host "Username: $username"
          Write-Host "Password: $password"
          Write-Host "====================`n"
          
          # Save to env
          echo "RDP_USER=$username" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          # Download and install Tailscale
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $output = "$env:TEMP\tailscale.msi"
          
          Write-Host "Downloading Tailscale..."
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
          
          Write-Host "Installing Tailscale silently..."
          Start-Process msiexec.exe -Wait -ArgumentList "/i `"$output`" /quiet /norestart"
          
          Remove-Item $output -Force
          Write-Host "Tailscale installed"

      - name: Connect to Tailscale
        run: |
          # Connect to Tailscale
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-rdp
          
          # Get IP with retry
          $maxRetries = 15
          $retryCount = 0
          $tsIP = $null
          
          Write-Host "Waiting for Tailscale IP..."
          while ($retryCount -lt $maxRetries -and -not $tsIP) {
              Start-Sleep -Seconds 4
              $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
              $retryCount++
              Write-Host "Attempt $retryCount/$maxRetries..."
          }
          
          if (-not $tsIP) {
              Write-Host "ERROR: Could not get Tailscale IP"
              exit 1
          }
          
          Write-Host "`n========================================="
          Write-Host "‚úÖ RDP ACCESS INFORMATION"
          Write-Host "========================================="
          Write-Host "IP Address  : $tsIP"
          Write-Host "Username    : $env:RDP_USER"
          Write-Host "Password    : $env:RDP_PASS"
          Write-Host "Port        : 3389"
          Write-Host "========================================="
          Write-Host ""
          
          echo "TS_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Verify Connection
        run: |
          # Simple verification
          Write-Host "Verifying RDP port is accessible..."
          $ip = $env:TS_IP
          
          # Test port
          $test = Test-NetConnection -ComputerName $ip -Port 3389 -WarningAction SilentlyContinue -InformationLevel Quiet
          
          if ($test) {
              Write-Host "‚úÖ PORT 3389 IS OPEN AND ACCESSIBLE"
          } else {
              Write-Host "‚ö†Ô∏è Port test failed - but might still work"
          }

      - name: Keep Alive
        run: |
          Write-Host ""
          Write-Host "========================================="
          Write-Host "üî¥ RDP SESSION ACTIVE - CONNECT NOW"
          Write-Host "========================================="
          Write-Host "Connection Details:"
          Write-Host "  IP : $env:TS_IP"
          Write-Host "  User: $env:RDP_USER"
          Write-Host "  Pass: $env:RDP_PASS"
          Write-Host ""
          Write-Host "To connect:"
          Write-Host "  Windows: mstsc.exe /v:$env:TS_IP"
          Write-Host "  Android/iOS: Use Microsoft Remote Desktop app"
          Write-Host "========================================="
          
          # Keep session alive
          $counter = 0
          while ($true) {
              $counter++
              $time = Get-Date -Format "HH:mm:ss"
              Write-Host "[$time] Session active for $counter minutes - Press Ctrl+C to stop"
              Start-Sleep -Seconds 60
          }
