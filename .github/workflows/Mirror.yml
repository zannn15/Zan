name: RDP Access

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP and Configure Firewall
        run: |
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Disable NLA
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          
          # Firewall
          netsh advfirewall firewall delete rule name="RDP-Port" 2>$null
          netsh advfirewall firewall add rule name="RDP-Port" dir=in action=allow protocol=TCP localport=3389
          
          # Restart service
          Restart-Service -Name TermService -Force
          Write-Host "âœ… RDP Enabled Successfully"

      - name: Create User with Complex Password
        run: |
          $username = "RDP"
          $password = "Vizzan15;"
          
          Write-Host "Creating user: $username"
          Write-Host "Password: $password"
          
          # Hapus user lama jika ada
          net user $username /delete 2>$null
          
          # Buat user baru dengan password yang sudah complex
          net user $username $password /add /fullname:"RDP User" /comment:"RDP Access User"
          
          # Add ke groups
          net localgroup Administrators $username /add
          net localgroup "Remote Desktop Users" $username /add
          
          # Enable user
          net user $username /active:yes
          
          # Verifikasi
          Write-Host "`n=== USER CREATED SUCCESSFULLY ==="
          Write-Host "Username: $username"
          Write-Host "Password: $password"
          Write-Host "Status: ACTIVE"
          Write-Host "Groups: Administrators, Remote Desktop Users"
          Write-Host "==================================`n"
          
          # Simpan ke environment
          echo "RDP_USER=$username" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $output = "$env:TEMP\tailscale.msi"
          
          Write-Host "Downloading Tailscale..."
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
          
          Write-Host "Installing Tailscale..."
          Start-Process msiexec.exe -Wait -ArgumentList "/i `"$output`" /quiet /norestart"
          
          Remove-Item $output -Force
          Write-Host "âœ… Tailscale installed"

      - name: Connect to Tailscale
        run: |
          # Connect ke Tailscale
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-rdp
          
          # Dapatkan IP dengan retry
          $maxRetries = 15
          $retryCount = 0
          $tsIP = $null
          
          Write-Host "Waiting for Tailscale IP..."
          while ($retryCount -lt $maxRetries -and -not $tsIP) {
              Start-Sleep -Seconds 4
              $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 2>$null
              $retryCount++
              Write-Host "Attempt $retryCount/$maxRetries..."
          }
          
          if (-not $tsIP) {
              Write-Host "âŒ ERROR: Could not get Tailscale IP"
              exit 1
          }
          
          # Display credentials dengan jelas
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "â•‘     ğŸ”¥ RDP ACCESS INFORMATION ğŸ”¥        â•‘"
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          Write-Host "â•‘ IP Address  : $tsIP"
          Write-Host "â•‘ Username    : $env:RDP_USER"
          Write-Host "â•‘ Password    : $env:RDP_PASS"
          Write-Host "â•‘ Port        : 3389"
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          
          echo "TS_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Verify Connection
        run: |
          $ip = $env:TS_IP
          
          Write-Host "Verifying RDP port 3389 on $ip..."
          
          # Test port
          $test = Test-NetConnection -ComputerName $ip -Port 3389 -WarningAction SilentlyContinue -InformationLevel Quiet
          
          if ($test) {
              Write-Host "âœ… PORT 3389 IS OPEN AND ACCESSIBLE"
          } else {
              Write-Host "âš ï¸ Port test failed - but might still work"
          }

      - name: Keep Alive
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "â•‘     ğŸ”´ RDP SESSION ACTIVE ğŸ”´             â•‘"
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          Write-Host "â•‘ Connect now with these details:          â•‘"
          Write-Host "â•‘                                          â•‘"
          Write-Host "â•‘   ğŸ“ IP : $env:TS_IP"
          Write-Host "â•‘   ğŸ‘¤ User: $env:RDP_USER"
          Write-Host "â•‘   ğŸ”‘ Pass: $env:RDP_PASS"
          Write-Host "â•‘                                          â•‘"
          Write-Host "â•‘ To connect:                              â•‘"
          Write-Host "â•‘   mstsc.exe /v:$env:TS_IP"
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          
          # Keep session alive dengan counter
          $counter = 0
          while ($true) {
              $counter++
              $time = Get-Date -Format "HH:mm:ss"
              $uptime = "$([math]::Floor($counter/60))h $($counter%60)m"
              Write-Host "[$time] Session active - Uptime: $uptime - Press Ctrl+C to stop"
              Start-Sleep -Seconds 60
          }
